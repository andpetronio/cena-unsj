<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Check-in Cena üéâ</title>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js';

    // üîß Variables globales (solo lo necesario en el front)
    const SUPABASE_URL = "https://okaqmkrkulfbaxxigvew.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rYXFta3JrdWxmYmF4eGlndmV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NzMzODgsImV4cCI6MjA3NDI0OTM4OH0.eV2Y68pAfT2yiwbaV2AiVSktCmFrineoYLpSdEqbS1c";                // anon key
    const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbwdOYdS9jte8GRG3UNKxeRnwiQ1l9dJAtYPdDawyiLJ5zhPdh5oU34ZxmtzGw0-g5s3VA/exec"; // WebApp con validaci√≥n PIN

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const params = new URLSearchParams(window.location.search);
    const codigo = params.get("codigo");

    let invitado = null;

    async function cargarInvitado() {
      if (!codigo) {
        document.getElementById("info").innerText = "‚ùå QR inv√°lido.";
        return;
      }

      const { data, error } = await supabase
        .from("invitados")
        .select("*")
        .eq("codigo_unico", codigo)
        .single();

      if (error || !data) {
        document.getElementById("info").innerText = "‚ùå Invitado no encontrado.";
        return;
      }

      invitado = data;
      document.getElementById("info").innerHTML = `
        <p><b>Nombre:</b> ${data.nombre}</p>
        <p><b>DNI:</b> ${data.dni}</p>
        <p><b>Lugar:</b> ${data.lugar}</p>
        <p><b>Estado actual:</b> ${data.estado}</p>
      `;
    }

    async function confirmarIngreso() {
      const pinIngresado = document.getElementById("pin").value;

      const resp = await fetch(APPSCRIPT_URL, {
        method: "POST",
        body: new URLSearchParams({ dni: invitado.dni, pin: pinIngresado })
      });
      const text = await resp.text();
      document.body.innerHTML = text;
    }

    async function marcarRechazado() {
      await supabase
        .from("invitados")
        .update({ estado: "no_identificado", hora_checkin: new Date() })
        .eq("id", invitado.id);

      document.body.innerHTML = "‚ùå No identificado";
    }

    window.confirmarIngreso = confirmarIngreso;
    window.marcarRechazado = marcarRechazado;
    cargarInvitado();
  </script>
</head>
<body>
  <h2>Verificaci√≥n de invitado</h2>
  <div id="info">Cargando...</div>

  <div id="acciones">
    <p>Ingrese PIN para confirmar ingreso:</p>
    <input type="password" id="pin" placeholder="PIN" />
    <button onclick="confirmarIngreso()">‚úÖ Confirmar ingreso</button>
    <button onclick="marcarRechazado()">‚ùå No identificado</button>
  </div>
</body>
</html>
